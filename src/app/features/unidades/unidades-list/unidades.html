<app-subheader 
  [filters]="subheaderFilters"
  [initialValues]="initialFilterValues"
  (submit)="onFilterSubmit($event)"
  [submitLabel]="'Aplicar'">
</app-subheader>

<!-- Secondary Filters Dropdown -->
<div class="secondary-filters-container">
  <button 
    type="button" 
    class="secondary-filters-toggle"
    (click)="toggleSecondaryFilters()"
    [class.active]="secondaryFiltersOpen">
    <i class="fa" [class.fa-chevron-down]="!secondaryFiltersOpen" [class.fa-chevron-up]="secondaryFiltersOpen"></i>
    <span>Más Filtros</span>
    @if (getActiveSecondaryFilters().length > 0) {
      <span class="filter-badge">{{ getActiveSecondaryFilters().length }}</span>
    }
  </button>

  @if (secondaryFiltersOpen) {
    <div class="secondary-filters-panel">
      <div class="filters-grid-container">
        <!-- Columna 1 -->
        <div class="filter-column">
          @for (filter of getFiltersByCategory('col1'); track filter.id) {
            <div class="filter-item">
              <label class="filter-label">{{ filter.label }}</label>
              @if (filter.type === 'typeahead') {
                <typeahead
                  [(ngModel)]="secondaryFilterValues[filter.id]"
                  [name]="filter.id"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [placeholder]="filter.placeholder || 'Buscar...'"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></typeahead>
              } @else {
                <app-filter
                  [id]="filter.id"
                  [type]="filter.type"
                  [label]="''"
                  [placeholder]="filter.placeholder || ''"
                  [values]="filter.values || []"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [min]="filter.min"
                  [max]="filter.max"
                  [step]="filter.step"
                  [minDate]="filter.minDate"
                  [maxDate]="filter.maxDate"
                  [multiple]="filter.multiple || false"
                  [validateOnBlur]="filter.validateOnBlur || false"
                  [ngModel]="secondaryFilterValues[filter.id]"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></app-filter>
              }
            </div>
          }
        </div>

        <!-- Columna 2 -->
        <div class="filter-column">
          @for (filter of getFiltersByCategory('col2'); track filter.id) {
            <div class="filter-item">
              <label class="filter-label">{{ filter.label }}</label>
              @if (filter.type === 'typeahead') {
                <typeahead
                  [(ngModel)]="secondaryFilterValues[filter.id]"
                  [name]="filter.id"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [placeholder]="filter.placeholder || 'Buscar...'"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></typeahead>
              } @else {
                <app-filter
                  [id]="filter.id"
                  [type]="filter.type"
                  [label]="''"
                  [placeholder]="filter.placeholder || ''"
                  [values]="filter.values || []"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [min]="filter.min"
                  [max]="filter.max"
                  [step]="filter.step"
                  [minDate]="filter.minDate"
                  [maxDate]="filter.maxDate"
                  [multiple]="filter.multiple || false"
                  [validateOnBlur]="filter.validateOnBlur || false"
                  [ngModel]="secondaryFilterValues[filter.id]"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></app-filter>
              }
            </div>
          }
        </div>

        <!-- Columna 3 -->
        <div class="filter-column">
          @for (filter of getFiltersByCategory('col3'); track filter.id) {
            <div class="filter-item">
              <label class="filter-label">{{ filter.label }}</label>
              @if (filter.type === 'typeahead') {
                <typeahead
                  [(ngModel)]="secondaryFilterValues[filter.id]"
                  [name]="filter.id"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [placeholder]="filter.placeholder || 'Buscar...'"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></typeahead>
              } @else {
                <app-filter
                  [id]="filter.id"
                  [type]="filter.type"
                  [label]="''"
                  [placeholder]="filter.placeholder || ''"
                  [values]="filter.values || []"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [min]="filter.min"
                  [max]="filter.max"
                  [step]="filter.step"
                  [minDate]="filter.minDate"
                  [maxDate]="filter.maxDate"
                  [multiple]="filter.multiple || false"
                  [validateOnBlur]="filter.validateOnBlur || false"
                  [ngModel]="secondaryFilterValues[filter.id]"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></app-filter>
              }
            </div>
          }
        </div>

        <!-- Columna 4 -->
        <div class="filter-column">
          @for (filter of getFiltersByCategory('col4'); track filter.id) {
            <div class="filter-item">
              <label class="filter-label">{{ filter.label }}</label>
              @if (filter.type === 'typeahead') {
                <typeahead
                  [(ngModel)]="secondaryFilterValues[filter.id]"
                  [name]="filter.id"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [placeholder]="filter.placeholder || 'Buscar...'"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></typeahead>
              } @else {
                <app-filter
                  [id]="filter.id"
                  [type]="filter.type"
                  [label]="''"
                  [placeholder]="filter.placeholder || ''"
                  [values]="filter.values || []"
                  [items]="filter.items || []"
                  [idKey]="filter.idKey || 'id'"
                  [labelKey]="filter.labelKey || 'label'"
                  [min]="filter.min"
                  [max]="filter.max"
                  [step]="filter.step"
                  [minDate]="filter.minDate"
                  [maxDate]="filter.maxDate"
                  [multiple]="filter.multiple || false"
                  [validateOnBlur]="filter.validateOnBlur || false"
                  [ngModel]="secondaryFilterValues[filter.id]"
                  (ngModelChange)="onSecondaryFilterChange({id: filter.id, value: $event})"
                ></app-filter>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }

  @if (!secondaryFiltersOpen && getActiveSecondaryFilters().length > 0) {
    <div class="secondary-filters-chips">
      @for (filter of getActiveSecondaryFilters(); track filter.label) {
        <span class="filter-chip">
          <span class="filter-chip-label">{{ filter.label }}:</span>
          <span class="filter-chip-value">{{ filter.value }}</span>
        </span>
      }
    </div>
  }
</div>

<div class="frame">
  <div class="frame-title">
    <h4>Unidades ({{ filteredUnidades.length }})</h4>
    <div class="frame-actions">
      @if (selectedUnidades.size > 0) {
        <button (click)="clearSelection()" class="btn c-btn btn-default pull-end m-r-sm">Limpiar selección ({{ selectedUnidades.size }})</button>
      }
      @if (selectedUnidades.size >= 2) {
        <button (click)="openCompareModal($event)" class="btn c-btn btn-primary pull-end m-r-sm">
          <i class="fa fa-balance-scale"></i> Comparar ({{ selectedUnidades.size }})
        </button>
      }
      <button (click)="goNuevo()" class="btn c-btn btn-primary pull-end">Nuevo</button>
    </div>
  </div>
  <div class="frame-body">
    <!-- Desktop Table View with horizontal scroll -->
    <div class="d-none d-md-block table-wrapper">
      <div class="scroll-table-horizontal">
        <table class="table c-table table-striped unidades-table">
          <thead>
            <tr>
              <th style="width: 40px; position: sticky; left: 0; background: white; z-index: 10;">
                <input 
                  type="checkbox" 
                  [checked]="isAllSelected()" 
                  [indeterminate]="isIndeterminate()"
                  (change)="toggleSelectAll($event)"
                  aria-label="Seleccionar todas">
              </th>
              <th>Unidad</th>
              <th>Tipo</th>
              <th>Proyecto</th>
              <th>Ciudad</th>
              <th>Barrio</th>
              <th>Cuartos</th>
              <th>Baños</th>
              <th>Tamaño</th>
              <th>Precio</th>
              <th>Expensas</th>
              <th>Disponibilidad</th>
              <th>Orientación</th>
              <th>Distribución</th>
              <th>Piso</th>
              <th>Extras</th>
              <th>Fecha entrega</th>
              <th style="position: sticky; right: 0; background: white; z-index: 10;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (it of filteredUnidades; track it) {
              <tr>
                <td style="width: 40px; position: sticky; left: 0; background: white; z-index: 9;">
                  <input 
                    type="checkbox" 
                    [checked]="isSelected(it.id)" 
                    (change)="toggleSelection(it.id, $event)"
                    (click)="$event.stopPropagation()"
                    aria-label="Seleccionar unidad">
                </td>
                <td>{{ it.nombre || it.name }}</td>
                <td>{{ it.tipoUnidad || it.tipo || '-' }}</td>
                <td>{{ getProyectoNombre(it) || '-' }}</td>
                <td>{{ getCiudadNombre(it) }}</td>
                <td>{{ getBarrioNombre(it) }}</td>
                <td>{{ it.dormitorios ?? it.cuartos ?? '-' }}</td>
                <td>{{ it.banos ?? '-' }}</td>
                <td>{{ getPrimarySize(it) || '-' }}</td>
                <td>{{ (it.precio ?? it.precioUSD) ? ((it.precio ?? it.precioUSD) | currency:'USD':'symbol':'1.0-0') : '-' }}</td>
                <td>{{ (it.expensasUSD ?? it.expensas) ? ((it.expensasUSD ?? it.expensas) | currency:'USD':'symbol':'1.0-0') : '-' }}</td>
                <td>{{ it.disponibilidad || it.estadoComercial || '-' }}</td>
                <td>{{ it.orientacion || '-' }}</td>
                <td>{{ it.distribucion || '-' }}</td>
                <td>{{ it.piso ?? '-' }}</td>
                <td>{{ getExtrasSummary(it) }}</td>
                <td>{{ it.entrega || it.fechaEntrega || '-' }}</td>
                <td class="text-end" style="position: sticky; right: 0; background: white; z-index: 9;">
                  <a href="javascript:;" (click)="goEditar(it.id); $event.stopPropagation()" class="btn-table" aria-label="Editar"><i class="fas fa-pen"></i></a>
                  <a href="javascript:;" class="btn-table" aria-label="Visitar"><i class="fa fa-external-link"></i></a>
                  <a href="javascript:;" (click)="eliminar(it.id, $event)" class="btn-table eliminar" aria-label="Eliminar"><i class="fa fa-trash"></i></a>
                </td>
              </tr>
            }
            @if (!filteredUnidades.length) {
              <tr>
                <td [attr.colspan]="18" class="text-center">Sin resultados</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Card View -->
    <div class="clickable-cards-container d-md-none">
      @for (it of filteredUnidades; track it) {
        <div class="clickable-card" (click)="verUnidad(it)">
          <div class="clickable-card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <input 
                type="checkbox" 
                [checked]="isSelected(it.id)" 
                (change)="toggleSelection(it.id, $event)"
                (click)="$event.stopPropagation()"
                aria-label="Seleccionar unidad">
              <span class="clickable-card-value highlight">{{ it.nombre || it.name }}</span>
            </div>
            <span class="d-flex align-items-center gap-2"> 
              <a href="javascript:;" (click)="goEditar(it.id); $event.stopPropagation()" class="btn-table" aria-label="Editar"><i class="fas fa-pen"></i></a>
              <a href="javascript:;" (click)="$event.stopPropagation()" class="btn-table" aria-label="Visitar"><i class="fa fa-external-link"></i></a>
              <a href="javascript:;" (click)="eliminar(it.id, $event)" class="btn-table eliminar" aria-label="Eliminar"><i class="fa fa-trash"></i></a>
            </span>
          </div>
          <div class="clickable-card-body">
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-building"></i>
                <span>Proyecto</span>
              </div>
              <div class="clickable-card-value">{{ getProyectoNombre(it) || '-' }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-map-marker-alt"></i>
                <span>Ciudad</span>
              </div>
              <div class="clickable-card-value">{{ getCiudadNombre(it) }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-map-marker-alt"></i>
                <span>Barrio</span>
              </div>
              <div class="clickable-card-value">{{ getBarrioNombre(it) }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-bed"></i>
                <span>Cuartos</span>
              </div>
              <div class="clickable-card-value">{{ it.dormitorios ?? it.cuartos ?? '-' }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-bath"></i>
                <span>Baños</span>
              </div>
              <div class="clickable-card-value">{{ it.banos ?? '-' }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-ruler"></i>
                <span>Tamaño</span>
              </div>
              <div class="clickable-card-value">{{ getPrimarySize(it) || '-' }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-dollar-sign"></i>
                <span>Precio</span>
              </div>
              <div class="clickable-card-value">{{ (it.precio ?? it.precioUSD) ? ((it.precio ?? it.precioUSD) | currency:'USD') : '-' }}</div>
            </div>
            <div class="clickable-card-row">
              <div class="clickable-card-label">
                <i class="fa fa-calendar"></i>
                <span>Fecha entrega</span>
              </div>
              <div class="clickable-card-value">{{ it.entrega || it.fechaEntrega || '-' }}</div>
            </div>
          </div>
        </div>
      }
      @if (!filteredUnidades.length) {
        <div class="clickable-card-empty">
          <i class="fa fa-cube"></i>
          <p>Sin resultados</p>
        </div>
      }
    </div>
  </div>
</div>
