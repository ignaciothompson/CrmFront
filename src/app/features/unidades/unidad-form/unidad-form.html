<div class="frame">
    <div class="frame-title">
        <h4>{{ id ? 'Editar Unidad' : 'Nueva Unidad' }}</h4>
    </div>
	<div class="frame-body">
		<!-- Tabs Navigation -->
		<div class="tabs-container">
			<ul class="nav nav-tabs">
				<li class="nav-item">
					<a class="nav-link" [class.active]="activeFormTab === 'basicos'" (click)="activeFormTab = 'basicos'" href="javascript:;">
						Datos Básicos
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" [class.active]="activeFormTab === 'proyecto'" (click)="activeFormTab = 'proyecto'" href="javascript:;">
						Proyecto / Ubicación
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" [class.active]="activeFormTab === 'extras'" (click)="activeFormTab = 'extras'" href="javascript:;">
						Extras y Equipamiento
					</a>
				</li>
			</ul>
		</div>

		<!-- Tab 1: Datos Básicos de la Unidad -->
		@if (activeFormTab === 'basicos') {
			<div class="tab-content">
				<!-- Primera fila: Tipo, Nombre, Piso (Solo si es apartamento) -->
				<div class="row">
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="tipoUnidad"
							type="select"
							label="Tipo de Propiedad"
							[values]="tipoUnidadFilterOptions"
							[(ngModel)]="model.tipoUnidad"
							name="tipoUnidad"
							[required]="true"
							>
						</app-filter>
					</div>
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="nombre"
							type="text"
							label="Nombre"
							placeholder="Ej: Unidad 101"
							[(ngModel)]="model.nombre"
							name="nombre"
							[required]="true">
						</app-filter>
					</div>
					@if (model.tipoUnidad === 'Apartamento') {
						<div class="col-xs-12 col-sm-4">
							<app-filter 
								id="piso"
								type="number"
								label="Piso"
								[(ngModel)]="model.piso"
								name="piso"
								[required]="true">
							</app-filter>
						</div>
					}
				</div>
				<!-- Segunda fila: Dormitorios, Baños, Tamaño, Tamaño Total -->
				<div class="row">
					<div class="col-xs-12 col-sm-2">
						<app-filter 
							id="dormitorios"
							type="number"
							label="Dormitorios"
							[(ngModel)]="model.dormitorios"
							name="dormitorios"
							[required]="true">
						</app-filter>
					</div>
					<div class="col-xs-12 col-sm-2">
						<app-filter 
							id="banos"
							type="number"
							label="Baños"
							[(ngModel)]="model.banos"
							name="banos"
							[required]="true">
						</app-filter>
					</div>
                    <!-- Campos específicos para Apartamento -->
                    @if (model.tipoUnidad === 'Apartamento') {
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="m2Internos"
                                type="number"
                                label="Tamaño Interior (m²)"
                                [(ngModel)]="model.m2Internos"
                                name="m2Internos"
                                [required]="true">
                            </app-filter>
                        </div>
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="m2Totales"
                                type="number"
                                label="Tamaño Total (m²)"
                                [(ngModel)]="model.m2Totales"
                                name="m2Totales"
                                [required]="true">
                            </app-filter>
                        </div>
                        <div class="col-xs-12 col-sm-2">
							<app-filter 
								id="altura"
								type="text"
								label="Altura"
								placeholder="Ej: 2,40m"
								[(ngModel)]="model.altura"
								name="altura"
								[required]="true">
							</app-filter>
						</div>
                    }
                    <!-- Campos específicos para Casa, Campo o Chacra -->
                    @if (model.tipoUnidad === 'Casa' || model.tipoUnidad === 'Campo' || model.tipoUnidad === 'Chacra') {
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="superficieTerreno"
                                type="number"
                                label="Metros Totales (m²)"
                                [(ngModel)]="model.superficieTerreno"
                                name="superficieTerreno"
                                [required]="true">
                            </app-filter>
                        </div>
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="superficieEdificada"
                                type="number"
                                label="Metros Edificados (m²)"
                                [(ngModel)]="model.superficieEdificada"
                                name="superficieEdificada"
                                [required]="true">
                            </app-filter>
                        </div>
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="plantas"
                                type="number"
                                label="Plantas"
                                [(ngModel)]="model.plantas"
                                name="plantas"
                                [required]="true">
                            </app-filter>
                        </div>
                    }
				</div>
				<!-- Tercera fila (si es apartamento): Orientación, Distribución, Altura -->
                <div class="row">
				    @if (model.tipoUnidad === 'Apartamento') {
						<div class="col-xs-12 col-sm-4">
							<app-filter 
								id="orientacion"
								type="select"
								label="Orientación"
								[values]="orientacionFilterOptions"
								[(ngModel)]="model.orientacion"
								name="orientacion"
								[required]="true">
							</app-filter>
						</div>
						<div class="col-xs-12 col-sm-4">
							<app-filter 
								id="distribucion"
								type="select"
								label="Distribución"
								[values]="distribucionFilterOptions"
								[(ngModel)]="model.distribucion"
								name="distribucion"
								[required]="true">
							</app-filter>
						</div>
                    }
                    <div class="col-xs-12 col-sm-4">
                        <app-filter 
                            id="estadoComercial"
                            type="select"
                            label="Estado Comercial"
                            [values]="estadoComercialFilterOptions"
                            [(ngModel)]="model.estadoComercial"
                            name="estadoComercial"
                            [required]="true">
                        </app-filter>
                    </div>
                </div>
				<!-- Cuarta fila: Responsable, Precio, Comisión -->
				<div class="row">
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="responsable"
							type="text"
							label="Responsable"
							placeholder="Agente o responsable"
							[(ngModel)]="model.responsable"
							name="responsable"
							[required]="true">
						</app-filter>
					</div>
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="precio"
							type="number"
							label="Precio (USD)"
							placeholder="Ej: 150000"
							[(ngModel)]="model.precioUSD"
							name="precioUSD"
							[required]="true">
						</app-filter>
					</div>
                    <div class="col-xs-12 col-sm-4">
                        <app-filter 
                            id="comision"
                            type="number"
                            label="Comisión (%)"
                            placeholder="Ej: 3"
                            [step]="0.01"
                            [(ngModel)]="model.comision"
                            name="comision"
                            [required]="true">
                        </app-filter>
                    </div>
				</div>
			</div>
		}

		<!-- Tab 2: Datos del Proyecto o Ubicación -->
		@if (activeFormTab === 'proyecto') {
			<div class="tab-content">
				<!-- Solo mostrar estos campos si NO es Casa o Campo -->
				@if (!isCasaOrCampoType()) {
					<div class="row">
						<div class="col-xs-12 col-sm-6 col-md-2">
                            <label class="c-label" for="proyectoSelectModeExistente">
                                <input type="radio" name="proyectoSelectMode" value="existente" [(ngModel)]="proyectoSelectMode" (click)="proyectoSelectMode = 'existente'" id="proyectoSelectModeExistente">
                                Proyecto Existente
                            </label>
						</div>
                        <div class="col-xs-12 col-sm-6 col-md-2">
                            <label class="c-label" for="proyectoSelectModeNuevo">
                                <input type="radio" name="proyectoSelectMode" value="nuevo" [(ngModel)]="proyectoSelectMode" (click)="proyectoSelectMode = 'nuevo'" id="proyectoSelectModeNuevo">
                                Nuevo Proyecto
                            </label>
                        </div>
					</div>
					<div class="row">
						@if (proyectoSelectMode === 'existente') {
							<div class="col-xs-12 col-sm-4">
								<app-filter 
									id="proyectoId"
									type="typeahead"
									label="Seleccionar Proyecto Existente"
									placeholder="Buscar proyecto existente..."
									[items]="proyectoItems"
									idKey="id"
									labelKey="label"
									[(ngModel)]="model.proyectoId"
									name="proyectoId"
									(ngModelChange)="onProyectoChange()">
								</app-filter>
							</div>
						} @else {
							<div class="col-xs-12 col-sm-4">
								<app-filter 
									id="proyectoNombre"
									type="text"
									label="Nombre del Proyecto"
									placeholder="Nombre del proyecto"
									[(ngModel)]="model.proyectoNombre"
									name="proyectoNombre"
									(blur)="onProyectoNombreBlur()">
								</app-filter>
							</div>
						}
						@if (proyectoSelectMode === 'existente' && model.proyectoId) {
							<div class="col-xs-12 col-sm-4">
								<app-filter 
									id="proyectoNombreDisplay"
									type="text"
									label="Nombre del Proyecto"
									placeholder="Nombre del proyecto"
									[(ngModel)]="model.proyectoNombre"
									name="proyectoNombreDisplay"
									[disabled]="true">
								</app-filter>
							</div>
						}
					</div>
				}
				<!-- Campos siempre visibles: Ciudad, Barrio -->
				<div class="row">
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="ciudad"
							type="select"
							label="Ciudad"
							[values]="ciudadFilterOptions"
							[(ngModel)]="model.ciudad"
							name="ciudad"
							[required]="isCasaOrCampoType()"
							[disabled]="model.tipoUnidad === 'Apartamento' && proyectoFieldsDisabled"
							(ngModelChange)="onCiudadChange()">
						</app-filter>
					</div>
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="barrio"
							type="select"
							label="Barrio"
							[values]="barrioFilterOptions"
							[(ngModel)]="model.barrio"
							name="barrio"
							[required]="isCasaOrCampoType()"
							[disabled]="!model.ciudad || (model.tipoUnidad === 'Apartamento' && proyectoFieldsDisabled)">
						</app-filter>
					</div>
					<div class="col-xs-12 col-sm-4">
						<app-filter 
							id="fechaEntrega"
							type="date"
							label="Fecha de Entrega"
							[(ngModel)]="model.fechaEntrega"
							name="fechaEntrega"
							[disabled]="model.tipoUnidad === 'Apartamento' && !!model.proyectoId">
						</app-filter>
						@if (model.tipoUnidad === 'Apartamento' && model.proyectoId) {
							<small class="text-muted">La fecha de entrega se guarda en el proyecto para apartamentos</small>
						}
					</div>
				</div>
			</div>
		}

		<!-- Tab 3: Datos Extras y Equipamiento -->
		@if (activeFormTab === 'extras') {
			<div class="tab-content">
				<div class="row">
					<!-- Terraza y Garage en la misma fila, ocupando 1 línea cada uno -->
					<div class="col-xs-12 col-sm-2">
						<app-filter 
							id="terraza"
							type="select"
							label="Terraza"
							[values]="terrazaOptions"
							[(ngModel)]="model.terraza"
							name="terraza"
							(ngModelChange)="onTerrazaChange()">
						</app-filter>
					</div>
                    <!-- Campos condicionales para Terraza -->
                    @if (model.terraza === 'Si') {
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="tamanoTerraza"
                                type="number"
                                label="Tamaño de Terraza (m²)"
                                [(ngModel)]="model.tamanoTerraza"
                                name="tamanoTerraza">
                            </app-filter>
                        </div>
                    }
					<div class="col-xs-12 col-sm-2">
						<app-filter 
							id="garage"
							type="select"
							label="Garage"
							[values]="garageOptions"
							[(ngModel)]="model.garage"
							name="garage"
							(ngModelChange)="onGarageChange()">
						</app-filter>
					</div>
                    <!-- Campos condicionales para Garage -->
                    @if (model.garage === 'Si' || model.garage === 'Extra') {
                        <div class="col-xs-12 col-sm-2">
                            <app-filter 
                                id="tamanoGarage"
                                type="number"
                                label="Tamaño de Garage (m²)"
                                [(ngModel)]="model.tamanoGarage"
                                name="tamanoGarage">
                            </app-filter>
                        </div>
                        @if (model.garage === 'Extra') {
                            <div class="col-xs-12 col-sm-2">
                                <app-filter 
                                    id="precioGarage"
                                    type="number"
                                    label="Precio Garage (USD)"
                                    placeholder="Ej: 21000"
                                    [(ngModel)]="model.precioGarage"
                                    name="precioGarage">
                                </app-filter>
                            </div>
                        }
                    }
				</div>
				
				<div class="row" style="margin-top: 20px;">
					<div class="col-xs-12">
						<label class="c-label">Amenities del Edificio/Proyecto</label>
						<div class="row">
							@for (amenity of amenitiesList; track amenity.key) {
								<div class="col-xs-12 col-sm-4 col-md-3">
									<div class="checkbox">
										<label>
											<input 
												type="checkbox" 
												[checked]="hasAmenity(amenity.key)" 
												(change)="toggleAmenity(amenity.key, $event)"
												name="amenity-{{amenity.key}}"> 
											{{ amenity.label }}
										</label>
									</div>
								</div>
							}
						</div>
					</div>
				</div>
			</div>
		}

		<!-- Tabla de Unidades Guardadas -->
		@if (savedUnidades.length > 0) {
			<div class="row" style="margin-top: 30px;">
				<div class="col-xs-12">
					<div class="separator"><span>Unidades Agregadas</span><hr></div>
					<div class="table-responsive">
						<table class="table c-table table-striped">
							<thead>
								<tr>
									<th>Nombre</th>
									<th>Piso</th>
									<th>Tamaño Interior (m²)</th>
									<th>Tamaño Total (m²)</th>
									<th style="width: 140px;">Acciones</th>
								</tr>
							</thead>
							<tbody>
								@for (unidad of savedUnidades; track unidad.id) {
									<tr>
										<td>{{ unidad.nombre || '-' }}</td>
										<td>{{ unidad.piso || '-' }}</td>
										<td>{{ unidad.m2Internos || '-' }}</td>
										<td>{{ unidad.m2Totales || '-' }}</td>
										<td>
											<a 
												href="javascript:;" 
												class="btn-table" 
												(click)="editSavedUnidad(unidad)"
												aria-label="Editar">
												<i class="fas fa-pen"></i>
											</a>
											<a 
												href="javascript:;" 
												class="btn-table eliminar" 
												(click)="deleteSavedUnidad(unidad)"
												aria-label="Eliminar">
												<i class="fa fa-trash"></i>
											</a>
										</td>
									</tr>
								}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		}
	</div>
    <div class="frame-footer">
        <button type="button" class="btn c-btn btn-default" (click)="activeModal?.dismiss()">Cancelar</button>
        @if (!id) {
            <button 
                type="button" 
                class="btn c-btn btn-white" 
                [disabled]="busy"
                (click)="addAndRepeatFromBulk()">
                Agregar y Repetir
            </button>
        }
        <button type="button" class="btn c-btn btn-primary" [disabled]="busy" (click)="save()">Guardar</button>
    </div>
</div>


