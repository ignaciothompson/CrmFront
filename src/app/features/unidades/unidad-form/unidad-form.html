<div class="frame">
    <div class="frame-title">
        <h4>{{ id ? 'Editar Unidad' : 'Nueva Unidad' }}</h4>
    </div>
	<div class="frame-body">
		<div class="row">
			<!-- Paso 1: Alcance -->
            <div class="col-xs-12 col-sm-4">
				<app-filter 
					id="alcance"
					type="select"
					label="Tipo de Unidad"
					[values]="alcanceOptions"
					[(ngModel)]="alcance"
					name="alcance"
					[disabled]="projectLocked">
				</app-filter>
			</div>
			@if (alcance === 'proyecto') {
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="proyectoModo"
						type="select"
						label="Proyecto"
						[values]="proyectoModoOptions"
						[(ngModel)]="proyectoModo"
						name="proyectoModo"
						[disabled]="projectLocked">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					@if (proyectoModo === 'existente') {
						<app-filter 
							id="proyecto"
							type="typeahead"
							label="Buscar Proyecto"
							placeholder="Buscar proyecto..."
							[items]="proyectoItems"
							idKey="id"
							labelKey="label"
							[(ngModel)]="model.proyectoId"
							name="proyectoId"
							(ngModelChange)="onProyectoChange()"
							[disabled]="projectLocked">
						</app-filter>
					}
				</div>
			}
		</div>

        <!-- Nuevo Proyecto -->
        @if (alcance === 'proyecto' && proyectoModo === 'nuevo') {
			<div class="separator"><span>Nuevo Proyecto</span><hr></div>
			<div class="row">
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npNombre"
						type="text"
						label="Nombre"
						placeholder="Nombre del proyecto"
						[(ngModel)]="nuevoProyecto.nombre"
						name="npNombre"
						[disabled]="projectLocked">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npDev"
						type="text"
						label="Desarrollador"
						placeholder="Empresa / Desarrollador"
						[(ngModel)]="nuevoProyecto.desarrollador"
						name="npDesarrollador"
						[disabled]="projectLocked">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npLoc"
						type="select"
						label="Localidad"
						[values]="ciudadFilterOptions"
						[(ngModel)]="nuevoProyecto.localidad"
						name="npLocalidad"
						[disabled]="projectLocked"
						(ngModelChange)="onNuevoProyectoLocalidadChange()">
					</app-filter>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npBarrio"
						type="select"
						label="Barrio"
						[values]="nuevoProyectoBarrioFilterOptions"
						[(ngModel)]="nuevoProyecto.barrio"
						name="npBarrio"
						[disabled]="projectLocked || !nuevoProyecto.localidad">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npDir"
						type="text"
						label="Dirección"
						placeholder="Dirección"
						[(ngModel)]="nuevoProyecto.direccion"
						name="npDireccion"
						[disabled]="projectLocked">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="npEnt"
						type="date"
						label="Fecha Entrega"
						[(ngModel)]="nuevoProyecto.entrega"
						name="npEntrega"
						[disabled]="projectLocked">
					</app-filter>
				</div>
			</div>
		}

		<div class="separator"><span>Datos Comunes</span><hr></div>
		<div class="row">
			<!-- Paso 2: Tipo de Unidad -->
			<div class="col-xs-12 col-sm-4">
				<app-filter 
					id="tipoUnidad"
					type="select"
					label="Tipo"
					[values]="tipoUnidadFilterOptions"
					[(ngModel)]="model.tipoUnidad"
					name="tipoUnidad"
					[disabled]="editingProyecto && !id">
				</app-filter>
			</div>

			<!-- Datos Comunes -->
			<div class="col-xs-12 col-sm-4">
				<app-filter 
					id="nombre"
					type="text"
					label="Nombre / Referencia"
					placeholder="Ej: Unidad 101"
					[(ngModel)]="model.nombre"
					name="nombre"
					[disabled]="editingProyecto && !id">
				</app-filter>
			</div>
			<div class="col-xs-12 col-sm-4">
				<app-filter 
					id="estadoComercial"
					type="select"
					label="Estado"
					[values]="estadoComercialFilterOptions"
					[(ngModel)]="model.estadoComercial"
					name="estadoComercial"
					[disabled]="editingProyecto && !id">
				</app-filter>
			</div>
			<div class="col-xs-12 col-sm-4">
				<app-filter 
					id="responsable"
					type="text"
					label="Responsable"
					placeholder="Agente o responsable"
					[(ngModel)]="model.responsable"
					name="responsable"
					[disabled]="editingProyecto && !id">
				</app-filter>
			</div>
            @if (alcance === 'unica' && (model.estadoComercial !== 'Vendida' && model.estadoComercial !== 'En Venta')) {
                <div class="col-xs-12 col-sm-4">
					<app-filter 
						id="entrega"
						type="date"
						label="Disponibilidad / Entrega (Est.)"
						[(ngModel)]="model.entrega"
						name="entrega">
					</app-filter>
                </div>
            }
            @if (alcance === 'unica') {
                    <div class="col-xs-12 col-sm-4">
						<app-filter 
							id="ubicacion"
							type="text"
							label="Ubicación"
							placeholder="Dirección"
							[(ngModel)]="model.ubicacion"
							name="ubicacion">
						</app-filter>
                    </div>
                    <div class="col-xs-12 col-sm-4">
						<app-filter 
							id="city"
							type="select"
							label="Ciudad"
							[values]="ciudadFilterOptions"
							[(ngModel)]="model.city"
							name="city"
							(ngModelChange)="onCityChange()">
						</app-filter>
                    </div>
                    <div class="col-xs-12 col-sm-4">
						<app-filter 
							id="barrio"
							type="select"
							label="Barrio / Zona"
							[values]="barrioFilterOptions"
							[(ngModel)]="model.barrio"
							name="barrio"
							[disabled]="!model.city">
						</app-filter>
                    </div>
            }
			<div class="col-xs-12 col-sm-4">
				<app-filter 
					id="comision"
					type="number"
					label="Comisión (%)"
					placeholder="Ej: 3"
					[step]="0.01"
					[(ngModel)]="model.comision"
					name="comision"
					[disabled]="editingProyecto && !id">
				</app-filter>
			</div>
		</div>
        @if (model.tipoUnidad) {
        <div class="row">
			<div class="separator"><span>Específicos</span><hr></div>
			<!-- Específicos: Apartamento -->
			@if (model.tipoUnidad === 'Apartamento') {
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="dormitorios"
						type="number"
						label="Dormitorios"
						[(ngModel)]="model.dormitorios"
						name="dormitorios"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="banos"
						type="number"
						label="Baños"
						[(ngModel)]="model.banos"
						name="banos"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="m2i"
						type="number"
						label="m² Internos"
						[(ngModel)]="model.m2Internos"
						name="m2Internos"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="m2t"
						type="number"
						label="m² Totales"
						[(ngModel)]="model.m2Totales"
						name="m2Totales"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="piso"
						type="number"
						label="Piso"
						[(ngModel)]="model.piso"
						name="piso"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="orientacion"
						type="select"
						label="Orientación"
						[values]="orientacionFilterOptions"
						[(ngModel)]="model.orientacion"
						name="orientacion"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12">
					<label class="c-label">Extras y Características</label>
					<div class="row">
						@for (e of apartmentExtras; track e) {
							<div class="col-xs-12 col-sm-4">
								<div class="checkbox">
									<label>
                    <input type="checkbox" [checked]="(model.extras || []).includes(e)" (change)="onExtraChange(e, $event.target.checked)" [disabled]="editingProyecto && !id"> {{ e }}
									</label>
								</div>
							</div>
						}
					</div>
				</div>
			}

			<!-- Específicos: Casa -->
			@if (model.tipoUnidad === 'Casa') {
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="dormitoriosC"
						type="number"
						label="Dormitorios"
						[(ngModel)]="model.dormitorios"
						name="dormitoriosCasa"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="banosC"
						type="number"
						label="Baños"
						[(ngModel)]="model.banos"
						name="banosCasa"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="m2e"
						type="number"
						label="Sup. Edificada (m²)"
						[(ngModel)]="model.superficieEdificada"
						name="superficieEdificada"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="m2st"
						type="number"
						label="Sup. Terreno (m²)"
						[(ngModel)]="model.superficieTerreno"
						name="superficieTerreno"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="antiguedad"
						type="number"
						label="Antigüedad (Años)"
						[(ngModel)]="model.antiguedad"
						name="antiguedad"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-2">
					<app-filter 
						id="condicion"
						type="select"
						label="Condición"
						[values]="condicionCasaFilterOptions"
						[(ngModel)]="model.condicion"
						name="condicion"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12">
					<label class="c-label">Extras y Características</label>
					<div class="row">
						@for (e of houseExtras; track e) {
							<div class="col-xs-12 col-sm-4">
								<div class="checkbox">
									<label>
                    <input type="checkbox" [checked]="(model.extras || []).includes(e)" (change)="onExtraChange(e, $event.target.checked)" [disabled]="editingProyecto && !id"> {{ e }}
									</label>
								</div>
							</div>
						}
					</div>
				</div>
			}

			<!-- Específicos: Chacra -->
			@if (model.tipoUnidad === 'Chacra') {
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="hectareasC"
						type="number"
						label="Hectáreas de Tierra"
						[step]="0.01"
						[(ngModel)]="model.hectareas"
						name="hectareasC"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="m2edif"
						type="number"
						label="m² Edificados"
						[(ngModel)]="model.m2Edificados"
						name="m2Edificados"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="dormR"
						type="number"
						label="Dormitorios (Casa)"
						[(ngModel)]="model.dormitorios"
						name="dormitoriosR"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="banosR"
						type="number"
						label="Baños (Casa)"
						[(ngModel)]="model.banos"
						name="banosR"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="tipoConst"
						type="text"
						label="Tipo de Construcción"
						[(ngModel)]="model.tipoConstruccion"
						name="tipoConstruccion"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="acceso"
						type="text"
						label="Acceso"
						[(ngModel)]="model.acceso"
						name="acceso"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<app-filter 
						id="infra"
						type="text"
						label="Infraestructura"
						placeholder="Galpones, corrales, etc."
						[(ngModel)]="model.infraestructura"
						name="infraestructura"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12">
					<label class="c-label">Servicios Básicos</label>
					<div class="row">
						<div class="col-xs-12 col-sm-4">
                            <label><input type="checkbox" [(ngModel)]="model.luz" name="luz" [disabled]="editingProyecto && !id" /> Luz eléctrica</label>
						</div>
						<div class="col-xs-12 col-sm-4">
                            <label><input type="checkbox" [(ngModel)]="model.agua" name="agua" [disabled]="editingProyecto && !id" /> Agua potable</label>
						</div>
						<div class="col-xs-12 col-sm-4">
                            <label><input type="checkbox" [(ngModel)]="model.internet" name="internet" [disabled]="editingProyecto && !id" /> Internet</label>
						</div>
					</div>
				</div>
			}

			<!-- Específicos: Campo -->
			@if (model.tipoUnidad === 'Campo') {
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="hectareasF"
						type="number"
						label="Hectáreas de Tierra"
						[step]="0.01"
						[(ngModel)]="model.hectareas"
						name="hectareasF"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="aptitud"
						type="select"
						label="Aptitud del Suelo"
						[values]="aptitudSueloOptions"
						[(ngModel)]="model.aptitudSuelo"
						name="aptitudSuelo"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="indice"
						type="number"
						label="Índice de Productividad"
						[step]="0.01"
						[(ngModel)]="model.indiceProductividad"
						name="indiceProductividad"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-3">
					<app-filter 
						id="accesoF"
						type="text"
						label="Acceso"
						[(ngModel)]="model.acceso"
						name="accesoF"
						[disabled]="editingProyecto && !id">
					</app-filter>
				</div>
				<div class="col-xs-12 col-sm-4">
					<label class="c-label" for="mejoras">Mejoras de Trabajo</label>
                    <textarea id="mejoras" class="form-control c-input" [(ngModel)]="model.mejorasTrabajo" name="mejorasTrabajo" placeholder="Alambrados, mangas, molinos..." [disabled]="editingProyecto && !id"></textarea>
				</div>
				<div class="col-xs-12 col-sm-4">
					<label class="c-label" for="infraHab">Infraestructura Habitacional</label>
                    <textarea id="infraHab" class="form-control c-input" [(ngModel)]="model.infraestructuraHabitacional" name="infraestructuraHabitacional" placeholder="Casa principal/personal" [disabled]="editingProyecto && !id"></textarea>
				</div>
				<div class="col-xs-12 col-sm-4">
					<label class="c-label" for="fuentes">Fuentes de Agua</label>
                    <textarea id="fuentes" class="form-control c-input" [(ngModel)]="model.fuentesAgua" name="fuentesAgua" placeholder="Arroyos, pozos, tajamares" [disabled]="editingProyecto && !id"></textarea>
				</div>
			}
		</div>
        }

		<!-- Tabla de Unidades (flujo proyecto) -->
		@if (alcance === 'proyecto') {
			<div class="row" style="margin-top: 16px;">
				<div class="col-xs-12">
					<div class="separator"><span>Unidades en {{ nuevoProyecto.nombre || 'Proyecto' }}</span><hr></div>
					<div class="table-responsive">
						<table class="table c-table table-striped">
							<thead>
								<tr>
									<th>Referencia</th>
									<th>Tipo</th>
									<th>M2 / Hectáreas</th>
									<th>Estado</th>
									<th style="width: 140px;">Acciones</th>
								</tr>
							</thead>
							<tbody>
                                @if (sessionUnits.length) {
                                    @for (u of sessionUnits; track u) {
                                        <tr [class]="u.id === id ? 'row-editing' : ''">
                                            <td>{{ u.nombre }}</td>
                                            <td>{{ u.tipoUnidad }}</td>
                                            <td>{{ getPrimarySize(u) }}</td>
                                            <td>{{ u.estadoComercial }}</td>
                                            <td>
                                                <a class="btn-table" (click)="editFromTable(u)">Editar</a>
                                                <a class="btn-table" (click)="deleteFromTable(u)" style="margin-left: 6px;">Eliminar</a>
                                            </td>
                                        </tr>
                                    }
                                } @else {
                                    <tr>
                                        <td colspan="5" class="text-center">No hay unidades en este proyecto</td>
                                    </tr>
                                }
							</tbody>
						</table>
					</div>
				</div>
			</div>
		}
	</div>
    <div class="frame-footer">
        <button type="button" class="btn c-btn btn-default" (click)="activeModal?.dismiss()">Cancelar</button>
        @if (alcance === 'proyecto' && !id) {
            <button class="btn c-btn btn-white" [disabled]="busy" (click)="addAndRepeat()">Agregar y Repetir</button>
        }
        <button type="button" class="btn c-btn btn-primary" [disabled]="busy" (click)="save()">Guardar</button>
    </div>
</div>